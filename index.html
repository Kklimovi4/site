<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è</title>
  <style>
    :root{
      --bg:#0e1320;
      --card:#151b2f;
      --muted:#2a355a;
      --text:#dbe2ff;
      --text-dim:#9aa7cf;
      --accent:#20d6a8;
      --accent-2:#1fb9f2;
      --danger:#ff4d4f;
      --radius:14px;
      --gap:16px;
    }
    *{box-sizing:border-box}
    body {
  margin: 0;
  background: radial-gradient(1200px 600px at 20% -10%, rgba(40,65,140,.35), transparent),
              linear-gradient(180deg, #0b1020 0%, #0a0d18 100%);
  color: var(--text);
  font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
  overflow-y: auto;      
  display: block;         
  min-height: 100vh;      
}
#loginModal {
  background: var(--card);
  padding: 20px;
  border-radius: var(--radius);
  position: fixed;  /* –ò–∑–º–µ–Ω–∏–º —Å absolute –Ω–∞ fixed, —á—Ç–æ–±—ã –æ–∫–Ω–æ –±—ã–ª–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;  /* –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—É–¥–µ—Ç —Å–≤–µ—Ä—Ö—É */
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%; /* –°–¥–µ–ª–∞—Ç—å —à–∏—Ä–∏–Ω—É 100% */
  height: 100%; /* –°–¥–µ–ª–∞—Ç—å –≤—ã—Å–æ—Ç—É 100% */
}

   .page {
  max-width: 1420px;
  margin: 28px auto;
  padding: 0 28px;
  overflow-x: auto;
}
    h1{font-weight:700; font-size:28px; margin:0 0 18px}
    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin: 6px 0 18px;
    }
    .tab{
      background:linear-gradient(180deg, #1a2240 0%, #141b33 100%);
      border:1px solid #26325a;
      color:var(--text);
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .15s ease, background .15s ease;
      box-shadow: 0 3px 0 rgba(0,0,0,.35);
    }
    .tab.active{
      background:linear-gradient(180deg, #1c2a56 0%, #152042 100%);
      outline:1px solid #2f4178;
      box-shadow: 0 0 0 2px rgba(47,65,120,.35);
    }
    .row{display:grid; gap:var(--gap)}
    .row.filters{
      grid-template-columns: 2fr 2fr 2fr 2fr 2fr 2fr;
      align-items:end;
    }
    .card{
      background:linear-gradient(180deg, #121a32 0%, #0f162d 100%);
      border:1px solid #26325a;
      border-radius:var(--radius);
      padding:14px;
    }
    label{display:block; color:var(--text-dim); font-size:12px; margin:0 0 6px}
    select, input[type="text"], input[type="password"]{
      width:100%; height:42px; border-radius:12px;
      border:1px solid #2b3a68;
      background:#0c1227; color:var(--text); padding:0 12px;
      outline:none; transition: border-color .15s ease, box-shadow .15s ease;
    }
    select:focus, input[type="text"]:focus, input[type="password"]:focus{border-color:#3d56a3; box-shadow:0 0 0 3px rgba(63,98,200,.25)}
    table{width:100%; border-collapse:collapse}
    th, td{padding:12px 14px; border-bottom:1px solid #26325a; text-align:left; vertical-align:top}
    th{color:#b9c6ee; font-weight:600; font-size:13px; letter-spacing:.02em}
    tr:hover td{background:rgba(41,58,104,.18)}
    .actions{display:flex; gap:8px; flex-direction:column}
    .btn{
      border:0; padding:10px 14px; border-radius:12px; cursor:pointer;
      font-weight:600; color:#0b1226; background:var(--accent);
      transition: transform .05s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:var(--accent-2)}
    .btn.danger{background:var(--danger); color:#fff}
    .layout{
      display:grid; grid-template-columns: 2.2fr 1.2fr; gap:var(--gap);
    }
    .muted{color:var(--text-dim)}
    .toast{
      position:fixed; right:20px; bottom:20px; padding:12px 16px;
      border-radius:12px; background:#172347; border:1px solid #2d3b6a; color:var(--text);
      box-shadow: 0 8px 30px rgba(0,0,0,.35); max-width:520px;
      z-index: 99;
    }
    .gear{
      margin-left:auto; display:flex; align-items:center; gap:8px;
      color:var(--text-dim); font-size:13px;
    }
    .gear input{width:280px}
    .empty{color:var(--text-dim); padding:18px}
    .hint{font-size:12px; color:var(--text-dim); margin-top:8px}
    .form-grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .form-actions{display:flex; gap:10px; margin-top:12px; align-items:center}

    /* --- –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
    @keyframes rowFadeIn {
      from { opacity:0; transform: translateY(-6px); }
      to   { opacity:1; transform: translateY(0); }
    }
    @keyframes rowFadeOut {
      to { opacity:0; transform: translateY(6px); }
    }
    tr.row-added td{
      animation: rowFadeIn .35s ease both;
      box-shadow: inset 0 0 0 1000px rgba(32,214,168,0.12);
    }
    tr.row-removed td{
      animation: rowFadeOut .25s ease forwards;
      background: rgba(255,77,79,.12);
    }

    /* ===== Drawer (–ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å) –¥–ª—è –§–∞–π–ª–æ–≤/–¢–∞–±–ª–∏—Ü ===== */
    .drawer-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; pointer-events:none; transition:.2s ease opacity;
      z-index: 90;
    }
    .drawer{
      position:fixed; top:0; right:-580px; width:580px; height:100vh;
      background:linear-gradient(180deg, #121a32 0%, #0f162d 100%);
      border-left:1px solid #26325a;
      box-shadow: -10px 0 30px rgba(0,0,0,.35);
      z-index: 91; transition:right .25s ease;
      display:flex; flex-direction:column;
    }
    .drawer.open{ right:0; }
    .drawer-backdrop.open{ opacity:1; pointer-events:auto; }
    .drawer-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px; border-bottom:1px solid #26325a;
    }
    .drawer-title{font-weight:700; font-size:18px}
    .drawer-body{padding:14px; overflow:auto; flex:1}
    .drawer-tabs{display:flex; gap:8px; padding:0 14px 10px; border-bottom:1px solid #26325a}
    .drawer-tab{
      background:linear-gradient(180deg, #1a2240 0%, #141b33 100%);
      border:1px solid #26325a; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .drawer-tab.active{
      background:linear-gradient(180deg, #1c2a56 0%, #152042 100%);
      outline:1px solid #2f4178;
    }
    .file-item{border:1px solid #2b3a68; border-radius:12px; padding:10px; margin:10px 0}
    .file-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .file-actions{display:flex; gap:8px; flex-wrap:wrap}
    .table-scroll{overflow:auto; border:1px solid #2b3a68; border-radius:10px; margin-top:8px}
    .mini-table{width:100%; border-collapse:collapse}
    .mini-table th, .mini-table td{border-bottom:1px solid #26325a; padding:8px 10px; white-space:nowrap}
    .soft{color:var(--text-dim); font-size:12px}
    .inline{display:inline-flex; gap:8px; align-items:center}
    .grid{display:grid; gap:10px}
    .grid-2{grid-template-columns: 1fr 1fr}
    .kbd{background:#111834; border:1px solid #2d3b6a; padding:1px 6px; border-radius:6px; font-size:12px; color:#cdd8ff}
    .pill{border:1px solid #2b3a68; padding:6px 10px; border-radius:999px}
    .input{height:38px; border-radius:10px; border:1px solid #2b3a68; background:#0c1227; color:var(--text); padding:0 10px; outline:none}
    .area{min-height:90px; border-radius:10px; border:1px solid #2b3a68; background:#0c1227; color:var(--text); padding:10px; outline:none}
    .divider{height:1px; background:#26325a; margin:12px 0}
    .row-actions{display:flex; gap:8px}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div id="appContainer" class="page" style="display:none;">
    <h1 style="display:flex;align-items:center;gap:12px;">
      –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ë–î
    </h1>
  <div style="position: absolute; right: 20px; top: 20px; color: var(--text-dim); font-size: 14px;">
    <span id="currentUserInfo"></span>
    <button onclick="logout()" class="btn secondary" style="margin-left: 10px; padding: 5px 10px;">–í—ã–π—Ç–∏</button>
  </div>

    <div class="tabs" id="tabs"></div>

    <!-- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä–æ—á–Ω–æ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º) -->
    <div class="row filters card" id="filters">
      <div data-filter="direction">
        <label>–î–∏—Ä–µ–∫—Ü–∏—è</label>
        <select id="f_direction"></select>
      </div>
      <div data-filter="department">
        <label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</label>
        <select id="f_department"></select>
      </div>
      <div data-filter="building">
        <label>–ó–¥–∞–Ω–∏–µ</label>
        <select id="f_building"></select>
      </div>
      <div data-filter="room">
        <label>–ü–æ–º–µ—â–µ–Ω–∏–µ</label>
        <select id="f_room"></select>
      </div>
      <div data-filter="row">
        <label>–†—è–¥ —à–∫–∞—Ñ–æ–≤</label>
        <select id="f_row"></select>
      </div>
      <div data-filter="cabinet">
        <label>–®–∫–∞—Ñ</label>
        <select id="f_cabinet"></select>
      </div>
    </div>

    <div class="layout">
      <div class="card">
        <h3 style="margin:0 0 10px" id="listTitle">–°–ø–∏—Å–æ–∫</h3>
        <div id="listContainer"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 10px" id="formTitle">–î–æ–±–∞–≤–∏—Ç—å</h3>
        <form id="form"></form>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <!-- ===== Drawer: –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Ñ–∞–π–ª–æ–≤/–∫–∞—Å—Ç–æ–º-—Ç–∞–±–ª–∏—Ü ===== -->
  <div id="drawerBackdrop" class="drawer-backdrop"></div>
  <aside id="filesDrawer" class="drawer" aria-hidden="true" inert>
    <div class="drawer-head">
      <div class="drawer-title" id="drawerTitle">–§–∞–π–ª—ã</div>
      <div class="inline">
        <button class="btn secondary" type="button" id="drawerCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
    <div class="drawer-tabs">
      <button id="tabFilesBtn" class="drawer-tab active" type="button">–§–∞–π–ª—ã</button>
    </div>
    <div class="drawer-body">
      <!-- –í–∫–ª–∞–¥–∫–∞ –§–∞–π–ª—ã -->
      <div id="tabFiles" style="display:block">
        <div class="grid grid-2">
          <div>
            <label class="soft">–ó–∞–≥—Ä—É–∑–∏—Ç—å Excel/CSV</label>
            <form id="uploadForm" class="inline" onsubmit="return false;">
              <input class="input" type="file" id="uploadFileInput" name="file" />
              <button class="btn" type="submit">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </form>
            <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è .xlsx, .xls, .csv. –ü–µ—Ä–≤—ã–π –ª–∏—Å—Ç –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω –∫–∞–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä.</div>
          </div>
          <div>
            <label class="soft">–ü–æ–¥—Å–∫–∞–∑–∫–∏</label>
            <div class="pill small">–ò–º—è —Ñ–∞–π–ª–∞ = –≤–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã/—Ä–∞—Å–∫–ª–∞–¥–∫–∞</div>
          </div>
        </div>

        <div class="divider"></div>
        <div id="filesList"></div>
      </div>
    </div>
  </aside>
 <div id="loginModal" style="display: flex; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;">
    <div style="background: var(--card); padding: 20px; border-radius: var(--radius); width: 320px; position: relative;">
      <h3 style="margin-top: 0;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>

      <div style="margin-bottom: 15px;">
        <label class="soft">API:</label>
        <input id="apiBaseInput" type="text" placeholder="https://ip:port/api" class="input" style="width: 100%; margin-bottom: 6px;" />
        <button class="btn secondary" id="saveApiBtn" type="button" style="width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <div style="margin-bottom: 15px;">
        <label>–õ–æ–≥–∏–Ω:</label>
        <input type="text" id="loginUsername" class="input" style="width: 100%;">
      </div>
      <div style="margin-bottom: 20px;">
        <label>–ü–∞—Ä–æ–ª—å:</label>
        <input type="password" id="loginPassword" class="input" style="width: 100%;">
      </div>
      <button class="btn" onclick="performLogin()" style="width: 100%;">–í–æ–π—Ç–∏</button>
    </div>
  </div>


  <script>
  // ---------- –ö–æ–Ω—Ñ–∏–≥ –≤–∫–ª–∞–¥–æ–∫ ----------
  const TABS = [
    {key:'directions',  title:'–î–∏—Ä–µ–∫—Ü–∏–∏'},
    {key:'departments', title:'–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è'},
    {key:'buildings',   title:'–ó–¥–∞–Ω–∏—è'},
    {key:'rooms',       title:'–ü–æ–º–µ—â–µ–Ω–∏—è'},
    {key:'rows',        title:'–†—è–¥—ã —à–∫–∞—Ñ–æ–≤'},
    {key:'cabinets',    title:'–®–∫–∞—Ñ—ã'},
    {key:'equipment',   title:'–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ'},
    {key:'employees',   title:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏'}
  ];

  // –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∫–ª–∞–¥–∫–∏
  const FILTERS_BY_TAB = {
    directions: [],
    departments: ['direction'],
    buildings: ['direction','department'],
    rooms: ['direction','department','building'],
    rows: ['direction','department','building','room'],
    cabinets: ['direction','department','building','room','row'],
    equipment: ['direction','department','building','room','row','cabinet'],
    employees: ['direction','department','building']
  };
document.getElementById('saveApiBtn').addEventListener('click', () => {
  const api = document.getElementById('apiBaseInput').value;
  if (api) {
    localStorage.setItem('apiBase', api);  // –°–æ—Ö—Ä–∞–Ω—è–µ–º API –≤ localStorage
    toast('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
  } else {
    toast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π API!');
  }
});

  const state = {
    tab: 'directions',
    dataLoaded: false,
    edit: null, // {endpoint,id,record}
    filters: {direction_id:null, department_id:null, building_id:null, room_id:null, row_id:null, cabinet_id:null},
    data: {
      directions:[], departments:[], buildings:[], rooms:[], rows:[], cabinets:[],
      equipment:[], employees:[]
    },
    lookupsLoaded:false,
    justAdded: null, // {endpoint,id,ts}
    user: null,
    drawer: {
      open: false,
      equipmentId: null,
      equipmentName: '',
      files: [],
      customTables: [],
      activeTab: 'files' // 'files' | 'custom'
    },
     autoRefresh: {
        enabled: true,
        interval: 30000, // 30 —Å–µ–∫—É–Ω–¥
        lastUpdate: null,
        timer: null
    }
  };

function startAutoRefresh() {
    if (state.autoRefresh.timer) {
        clearInterval(state.autoRefresh.timer);
    }
    
    state.autoRefresh.timer = setInterval(async () => {
        await checkForUpdates();
    }, state.autoRefresh.interval);
    
    console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
}

function stopAutoRefresh() {
    if (state.autoRefresh.timer) {
        clearInterval(state.autoRefresh.timer);
        state.autoRefresh.timer = null;
    }
    console.log('–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
}


async function checkNameUnique(endpoint, name, excludeId = null) {
  try {
    const data = await apiGet(endpoint);
    const existing = data.find(item => 
      item.name.toLowerCase() === name.toLowerCase() && 
      item.id !== excludeId
    );
    return !existing; // true –µ—Å–ª–∏ –∏–º—è —É–Ω–∏–∫–∞–ª—å–Ω–æ
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏ –¥–ª—è ${endpoint}:`, error);
    return true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  }
}

async function checkRoomUnique(name, buildingId, excludeId = null) {
  try {
    const rooms = await apiGet('rooms');
    const existing = rooms.find(room => 
      room.name.toLowerCase() === name.toLowerCase() && 
      room.building_id === buildingId &&
      room.id !== excludeId
    );
    return !existing;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–º–µ—â–µ–Ω–∏—è:', error);
    return true;
  }
}

async function checkCabinetUnique(name, rowId, excludeId = null) {
  try {
    const cabinets = await apiGet('cabinets');
    const existing = cabinets.find(cabinet => 
      cabinet.name.toLowerCase() === name.toLowerCase() && 
      cabinet.cabinet_row_id === rowId &&
      cabinet.id !== excludeId
    );
    return !existing;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —à–∫–∞—Ñ–∞:', error);
    return true;
  }
}

async function checkEquipmentUnique(name, cabinetId, excludeId = null) {
  try {
    const equipment = await apiGet('equipment');
    const existing = equipment.find(item => 
      item.name.toLowerCase() === name.toLowerCase() && 
      item.cabinet_id === cabinetId &&
      item.id !== excludeId
    );
    return !existing;
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è:', error);
    return true;
  }
}

async function refreshCurrentTabData() {
    const endpoint = getCurrentEndpoint();
    console.log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è: ${endpoint}`);
    
    try {
        const freshData = await apiGet(endpoint);
        const filterFn = getDataFilter(endpoint);
        const filteredData = filterFn ? freshData.filter(filterFn) : freshData;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
        const collectionKey = getCollectionKey(endpoint);
        state.data[collectionKey] = filteredData;
        
        // –î–û–ë–ê–í–õ–ï–ù–û: –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –ø—Ä–∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        updateLookupsCache();
        
        console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${filteredData.length} –∑–∞–ø–∏—Å–µ–π`);
        return true;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
        return false;
    }
}
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
function getCollectionKey(endpoint) {
    const map = {
        'directions': 'directions',
        'departments': 'departments', 
        'buildings': 'buildings',
        'rooms': 'rooms',
        'cabinet_rows': 'rows',
        'cabinets': 'cabinets',
        'equipment': 'equipment',
        'employees_info': 'employees'
    };
    return map[endpoint] || endpoint;
}

async function checkForUpdates() {
    try {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
        const result = await apiGet('site/last-updates');
        const currentUpdate = result.last_update;
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–ª–∏ –≤—Ä–µ–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
        if (!state.autoRefresh.lastUpdate || state.autoRefresh.lastUpdate !== currentUpdate) {
            console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è—é —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É...');
            await refreshCurrentTabData();
            render();
            toast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 2000);
        } else {
            console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
        }
        
        state.autoRefresh.lastUpdate = currentUpdate;
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
    }
}
function getCurrentEndpoint() {
  switch(state.tab) {
    case 'directions': return 'directions';
    case 'departments': return 'departments';
    case 'buildings': return 'buildings';
    case 'rooms': return 'rooms';
    case 'rows': return 'cabinet_rows';
    case 'cabinets': return 'cabinets';
    case 'equipment': return 'equipment';
    case 'employees': return 'employees_info';
    default: return state.tab;
  }
}

function debugUserAndData() {
  console.log("=== DEBUG INFO ===");
  console.log("User:", state.user);
  console.log("Current tab:", state.tab);
  console.log("Data loaded:", state.lookupsLoaded);
  
  if (state.user) {
    console.log("User direction_id:", state.user.direction_id);
    console.log("User role:", state.user.role);
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∏–º, –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
  console.log("Directions count:", state.data.directions.length);
  console.log("Departments count:", state.data.departments.length);
  console.log("Buildings count:", state.data.buildings.length);
  
  // –ü—Ä–æ–≤–µ—Ä–∏–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
  const endpoint = getCurrentEndpoint();
  console.log("Current endpoint:", endpoint);
  
  const filterFn = getDataFilter(endpoint);
  console.log("Filter function exists:", !!filterFn);
  
  if (filterFn && state.data[endpoint]) {
    const filteredData = state.data[endpoint].filter(filterFn);
    console.log(`Filtered data for ${endpoint}:`, filteredData.length, "items");
    console.log("Filtered items:", filteredData);
  } else if (state.data[endpoint]) {
    console.log(`All data for ${endpoint}:`, state.data[endpoint].length, "items");
  }
  
  console.log("=== END DEBUG ===");
}

  function toast(msg, ms=2600){
    const box = document.getElementById('toast');
    box.innerHTML = msg;
    box.style.display = 'block';
    setTimeout(()=> box.style.display='none', ms);
  }

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ–≥–∏–Ω–∞
function showLoginModal() {
  document.getElementById('loginModal').style.display = 'flex'; // Show login modal
  document.getElementById('appContainer').style.display = 'none'; // Hide app content
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª–æ–≥–∏–Ω–∞
async function performLogin() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        toast('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    try {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(username + ':' + password)
        };
        
        const url = getApiBase().replace(/\/$/, '') + '/login';
        const res = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ login: username, password })
        });
        
        if (!res.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
        }
        
        const result = await res.json();
        
        if (result.success) {
            state.user = {
                login: username,
                password: password,
                department_id: result.department_id,
                direction_id: result.direction_id,
                full_name: result.full_name,
                role: result.role
            };
            
            localStorage.setItem('userData', JSON.stringify(state.user));
            
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –û–î–ò–ù —Ä–∞–∑
            await loadLookups();
            bindFilterEvents();
            resetFilters();
            updateUIForUserRole();
            updateUserInfo();
            await render(); // render —Ç–µ–ø–µ—Ä—å –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
            
            startAutoRefresh();
            
            toast('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
            return true;
        } else {
            toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞:', error);
        
        if (error.message.includes('401')) {
            toast('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        } else {
            toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
        }
        
        return false;
    }
}
// ---------- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ----------
function updateUIForUserRole() {
  const role = state.user?.role?.toLowerCase();
  const tabs = document.querySelectorAll('.tabs button');
  
 tabs.forEach(btn => {
    const tab = btn.getAttribute('data-tab');
    btn.style.display = 'none'; // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ
    if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
      if (['rooms', 'rows', 'cabinets', 'equipment'].includes(tab)) {
        btn.style.display = 'inline-block';
      }
    }
    else if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä') {
      if (tab === 'employees') {
        btn.style.display = 'inline-block';
      }
    }
    else if (role === '–≥–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä') {
      if (['buildings', 'rooms', 'rows', 'cabinets', 'equipment', 'employees'].includes(tab)) {
        btn.style.display = 'inline-block';
      }
    }
    else if (role === '—Ü—Å—Å') {
      if (['directions', 'departments', 'buildings', 'rooms', 'rows', 'cabinets', 'equipment', 'employees'].includes(tab)) {
        btn.style.display = 'inline-block';
       }
      }
  });

  // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ —Å–∫—Ä—ã—Ç–∞ ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω—É—é
  const activeTab = document.querySelector('.tabs button.active');
  if (activeTab && activeTab.style.display === 'none') {
    const firstVisible = [...tabs].find(btn => btn.style.display !== 'none');
    if (firstVisible) {
      firstVisible.click();
    }
  }
}

function getDataFilter(endpoint) {
  // --- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π endpoint-–æ–≤ ---
  const map = {
    rows: 'cabinet_rows',
    employees: 'employees_info'
  };
  endpoint = map[endpoint] || endpoint;

  const role = state.user?.role?.toLowerCase();

  if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
    return (item) => {
      if (endpoint === 'rooms') {
        const building = state.data.buildings.find(b => b.id == item.building_id);
        return building && building.department_id === state.user.department_id;
      }
      if (endpoint === 'cabinet_rows') {
        const room = state.data.rooms.find(r => r.id == item.room_id);
        if (!room) return false;
        const building = state.data.buildings.find(b => b.id == room.building_id);
        return building && building.department_id === state.user.department_id;
      }
      if (endpoint === 'cabinets') {
        const row = state.data.rows.find(r => r.id == item.cabinet_row_id);
        if (!row) return false;
        const room = state.data.rooms.find(r => r.id == row.room_id);
        const building = state.data.buildings.find(b => b.id == room.building_id);
        return building && building.department_id === state.user.department_id;
      }
      if (endpoint === 'equipment') {
        const cabinet = state.data.cabinets.find(c => c.id == item.cabinet_id);
        if (!cabinet) return false;
        const row = state.data.rows.find(r => r.id == cabinet.cabinet_row_id);
        const room = state.data.rooms.find(r => r.id == row.room_id);
        const building = state.data.buildings.find(b => b.id == room.building_id);
        return building && building.department_id === state.user.department_id;
      }
      return true;
    };
  }

  if (role === '–≥–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä') {
  return (item) => {
    if (endpoint === 'directions') {
      return item.id === state.user.direction_id;
    }
    if (endpoint === 'departments' || endpoint === 'employees_info') {
      return item.direction_id === state.user.direction_id;
    }
    if (endpoint === 'buildings') {
      const dep = state.data.departments.find(d => d.id == item.department_id);
      return dep && dep.direction_id === state.user.direction_id;
    }
    if (endpoint === 'rooms') {
      const building = state.data.buildings.find(b => b.id == item.building_id);
      if (!building) return false;
      const dep = state.data.departments.find(d => d.id == building.department_id);
      return dep && dep.direction_id === state.user.direction_id;
    }
    if (endpoint === 'cabinet_rows') {
      const room = state.data.rooms.find(r => r.id == item.room_id);
      if (!room) return false;
      const building = state.data.buildings.find(b => b.id == room.building_id);
      if (!building) return false;
      const dep = state.data.departments.find(d => d.id == building.department_id);
      return dep && dep.direction_id === state.user.direction_id;
    }
    if (endpoint === 'cabinets') {
      const row = state.data.rows.find(r => r.id == item.cabinet_row_id);
      if (!row) return false;
      const room = state.data.rooms.find(r => r.id == row.room_id);
      if (!room) return false;
      const building = state.data.buildings.find(b => b.id == room.building_id);
      if (!building) return false;
      const dep = state.data.departments.find(d => d.id == building.department_id);
      return dep && dep.direction_id === state.user.direction_id;
    }
    if (endpoint === 'equipment') {
      const cabinet = state.data.cabinets.find(c => c.id == item.cabinet_id);
      if (!cabinet) return false;
      const row = state.data.rows.find(r => r.id == cabinet.cabinet_row_id);
      if (!row) return false;
      const room = state.data.rooms.find(r => r.id == row.room_id);
      if (!room) return false;
      const building = state.data.buildings.find(b => b.id == room.building_id);
      if (!building) return false;
      const dep = state.data.departments.find(d => d.id == building.department_id);
      return dep && dep.direction_id === state.user.direction_id;
    }
    return true;
  };
}

  if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä') {
    return (item) => {
      if (endpoint === 'employees_info') {
        return item.department_id === state.user.department_id;
      }
      if (endpoint === 'departments') {
        return item.id === state.user.department_id;
      }
      if (endpoint === 'buildings') {
        return item.department_id === state.user.department_id;
      }
      if (endpoint === 'directions') {
        return item.id === state.user.direction_id;
      }
      return false;
    };
  }
  if (role === '—Ü—Å—Å') {
      return null; // –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    }

  return null;
}

async function fetchAndRender(endpoint) {
  const filterFn = getDataFilter(endpoint);
  const data = await api(endpoint);
  return filterFn ? data.filter(filterFn) : data;
}

function updateUserInfo() {
  if (state.user) {
    const dep = state.data.departments.find(d => d.id == state.user.department_id);
    const dir = state.data.directions.find(d => d.id == state.user.direction_id);
    let info = `${state.user.full_name} (${state.user.role})`;
    if (dir) info += ` ¬∑ ${dir.name}`;
    if (dep) info += ` ¬∑ ${dep.name}`;
     const autoRefreshText = state.autoRefresh.enabled ? 'üîÑ –í–∫–ª' : '‚è∏Ô∏è –í—ã–∫–ª';
        byId('currentUserInfo').innerHTML = `
            ${info} 
            <button onclick="toggleAutoRefresh()" class="btn secondary" style="margin-left: 10px; padding: 2px 8px; font-size: 12px;">
                ${autoRefreshText}
            </button>
        `;
    }
}

function toggleAutoRefresh() {
    state.autoRefresh.enabled = !state.autoRefresh.enabled;
    
    if (state.autoRefresh.enabled) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
    
    updateUserInfo();
    toast(`–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${state.autoRefresh.enabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
}

function logout() {
  state.user = null;
  state.data = {
    directions:[], departments:[], buildings:[], rooms:[], rows:[], cabinets:[],
    equipment:[], employees:[]
  };
  state.lookupsLoaded = false;
  stopAutoRefresh();
  localStorage.removeItem('userData');
  localStorage.removeItem('lookupsCache');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ª–æ–≥–∏–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('appContainer').style.display = 'none';
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
}
  // ---------- API helpers ----------
  function getApiBase(){
    return localStorage.getItem('apiBase') || document.getElementById('apiBaseInput').placeholder;
  }
  function getAuthHeaders() {
  const headers = {
    'Content-Type': 'application/json'
  };
  if (state.user) {
    const userData = JSON.parse(localStorage.getItem('userData'));
    if (userData && userData.login) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Basic Auth
      headers['Authorization'] = 'Basic ' + btoa(userData.login + ':' + (userData.password || ''));
    }
  }
  
  return headers;
}
  async function apiGet(path){
  const cleanPath = path.replace(/^\/api\//, '/');
  const url = getApiBase().replace(/\/$/, '') + '/' + cleanPath.replace(/^\//,'');
  try {
    const res = await fetch(url, {
      headers: getAuthHeaders()
    });
    
    if (!res.ok) {
      console.warn('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', res.status, url);
      
      // –ï—Å–ª–∏ 401 - —Ä–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º
      if (res.status === 401) {
        toast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥.');
        setTimeout(() => logout(), 2000);
      }
      
      throw new Error('HTTP ' + res.status + ' ‚Äî ' + url);
    }

    let json;
    try {
      json = await res.json();
    } catch {
      console.error('–û—Ç–≤–µ—Ç –Ω–µ JSON:', url);
      return [];
    }
    return json;
  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ GET', err.message);
    
    if (err.message.includes('401')) {
      toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
    } else {
      toast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + err.message);
    }
    
    return [];
  }
}
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏
async function apiPost(path, body) {
  const url = getApiBase().replace(/\/$/, '') + '/' + path.replace(/^\//, '');
  try {
    const res = await fetch(url, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const errorText = await res.text();
      let errorMessage = `–û—à–∏–±–∫–∞ ${res.status}: ${errorText}`;
      
      // –ü–∞—Ä—Å–∏–º JSON –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
      try {
        const errorJson = JSON.parse(errorText);
        if (errorJson.error && errorJson.error.includes('unique')) {
          errorMessage = '–û—à–∏–±–∫–∞: –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        } else if (errorJson.error) {
          errorMessage = `–û—à–∏–±–∫–∞: ${errorJson.error}`;
        }
      } catch {
        // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å
      }
      
      throw new Error(errorMessage);
    }

    const data = await res.json();
    console.log('–î–æ–±–∞–≤–ª–µ–Ω–æ:', data);
    toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');

    updateLocalDataAfterChange(path, data, 'add');
    return data;

  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ POST:', err);
    toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å: ' + err.message, 4000);
    return null;
  }
}


// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏
async function apiPut(path, body) {
  const url = getApiBase().replace(/\/$/, '') + '/' + path.replace(/^\//, '');
  try {
    const res = await fetch(url, {
      method: 'PUT',
      headers: getAuthHeaders(),
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const msg = await res.text();
      throw new Error(`–û—à–∏–±–∫–∞ ${res.status}: ${msg}`);
    }

    const data = await res.json();
    console.log('–ò–∑–º–µ–Ω–µ–Ω–æ:', data);
    toast('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–æ');

    updateLocalDataAfterChange(path, data, 'update');
    return data;

  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ PUT:', err);
    toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å: ' + err.message, 4000);
    return null;
  }
}


// –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
async function apiDelete(path) {
  const url = getApiBase().replace(/\/$/, '') + '/' + path.replace(/^\//, '');
  try {
    const res = await fetch(url, { 
      method: 'DELETE',
      headers: getAuthHeaders()
    });

    if (!res.ok) {
      const msg = await res.text();
      throw new Error(`–û—à–∏–±–∫–∞ ${res.status}: ${msg}`);
    }

    toast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
    updateLocalDataAfterChange(path, null, 'delete');
    return true;

  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ DELETE:', err);
    toast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + err.message, 4000);
    return false;
  }
}
  async function apiPostForm(path, formData){
  const url = getApiBase().replace(/\/$/, '') + '/' + path.replace(/^\//,'');
  
  // –î–ª—è FormData –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Content-Type, –±—Ä–∞—É–∑–µ—Ä —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏—Ç
  const headers = {};
  if (state.user) {
    const userData = JSON.parse(localStorage.getItem('userData'));
    if (userData && userData.login) {
      headers['Authorization'] = 'Basic ' + btoa(userData.login + ':' + (userData.password || ''));
    }
  }
  
  const res = await fetch(url, { 
    method: 'POST', 
    headers,
    body: formData 
  });
  
  if(!res.ok){
    let t = await res.text().catch(()=> '');
    throw new Error('HTTP '+res.status+' ‚Äî '+t);
  }
  return await res.json().catch(()=>({ok:true}));
}

function updateLocalDataAfterChange(path, item, action) {
    let key = path.split('/')[0];
    const endpointToKeyMap = {
        'employees_info': 'employees',
        'cabinet_rows': 'rows',
        'directions': 'directions',
        'departments': 'departments', 
        'buildings': 'buildings',
        'rooms': 'rooms',
        'cabinets': 'cabinets',
        'equipment': 'equipment'
    };
    
    key = endpointToKeyMap[key] || key;
    const collection = state.data[key];
    
    if (!Array.isArray(collection)) {
        console.warn('Collection not found for key:', key);
        return;
    }

    switch (action) {
        case 'add':
            collection.push(item);
            break;
        case 'update':
            const idx = collection.findIndex(x => x.id === item.id);
            if (idx !== -1) collection[idx] = item;
            break;
        case 'delete':
            const id = parseInt(path.split('/').pop(), 10);
            state.data[key] = collection.filter(x => x.id !== id);
            break;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    state.autoRefresh.lastUpdate = new Date().toISOString();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
    updateLookupsCache();

    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => {
        try { 
            render(); 
        } catch (e) { 
            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ render()', e); 
        }
    }, 100);
}

// ---------- –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏–Ω–∞ ----------

async function checkLoginUnique(login, excludeId = null) {
  try {
    const employees = await apiGet('employees_info');
    const existing = employees.find(emp => 
      emp.login.toLowerCase() === login.toLowerCase() && 
      emp.id !== excludeId
    );
    return !existing; // true –µ—Å–ª–∏ –ª–æ–≥–∏–Ω —É–Ω–∏–∫–∞–ª–µ–Ω
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–Ω–∞:', error);
    return true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  }
}

async function loginUser(login, password) {
    try {
        const result = await apiPost('/login', { login, password });
        
        if (result.success) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            state.user = {
                department_id: result.department_id,
                direction_id: result.direction_id,
                role: result.role,
                full_name: result.full_name
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('userData', JSON.stringify(state.user));
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            // –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadLookups();
            bindFilterEvents();
            resetFilters();
            updateUIForUserRole();
            updateUserInfo();
            await render();
            
            toast('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
            return true;
        } else {
            toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ª–æ–≥–∏–Ω–∞:', error);
        toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
        return false;
    }
}

  // ---------- UI bootstrap ----------
  function buildTabs(){
    const wrap = document.getElementById('tabs');
    wrap.innerHTML = '';
    for(const t of TABS){
      const b = document.createElement('button');
      b.className = 'tab'+(state.tab===t.key?' active':'');
      b.textContent = t.title;
	b.setAttribute('data-tab', t.key);
      b.onclick = ()=> switchTab(t.key);
      wrap.appendChild(b);
    }
  }

  async function switchTab(key){
    state.tab = key;
    state.edit = null;
    buildTabs();
    resetFilters(); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
    updateFiltersVisibility();
    await render();
  }

  function resetFilters(){
    // –ü—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
  state.filters = {
    direction_id: null,
    department_id: null, 
    building_id: null,
    room_id: null,
    row_id: null,
    cabinet_id: null
  };
  
  byId('f_direction').value = '';
  byId('f_department').value = '';
  byId('f_building').value = '';
  byId('f_room').value = '';
  byId('f_row').value = '';
  byId('f_cabinet').value = '';
  
  // –∫–∞—Å–∫–∞–¥ - —Ñ—É–Ω–∫—Ü–∏—è fillAllFilterOptions —Å–∞–º–∞ –ø—Ä–∏–º–µ–Ω–∏—Ç —Ä–æ–ª–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
  fillAllFilterOptions();
}

 async function loadLookups(forceRefresh = false) {
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –≤—ã—Ö–æ–¥–∏–º
    if (state.dataLoaded && !forceRefresh) {
        console.log('üìÅ –î–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
        fillAllFilterOptions();
        return;
    }
    
    console.log('üì• –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...', forceRefresh ? '(–ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û)' : '');
    
    const MAX_CACHE_AGE = 10 * 60 * 1000;
    
    if (!forceRefresh) {
        const cached = localStorage.getItem('lookupsCache');
        if (cached) {
            try {
                const parsed = JSON.parse(cached);
                const cacheAge = Date.now() - new Date(parsed.lastUpdated).getTime();
                const isCacheValid = parsed.userRole === state.user?.role && 
                                    cacheAge < MAX_CACHE_AGE;
                
                if (isCacheValid) {
                    state.data = parsed.data;
                    state.lookupsLoaded = true;
                    state.dataLoaded = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
                    fillAllFilterOptions();
                    console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –∫—ç—à–∞ (' + Math.round(cacheAge/1000/60) + ' –º–∏–Ω)');
                    return;
                }
            } catch (err) {
                console.warn('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞:', err);
            }
        }
    }

    console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞...');
    await loadEssentialData();
}

async function loadEssentialData() {
    const essentialEndpoints = [
        'directions', 'departments', 'buildings',
        'rooms', 'cabinet_rows', 'cabinets',
        'equipment', 'employees_info'
    ];
    
    try {
        const results = await Promise.all(
            essentialEndpoints.map(ep => apiGet(ep).catch(() => []))
        );

        const [
            directions, departments, buildings,
            rooms, rows, cabinets, equipment, employees
        ] = results;

        state.data = {
            directions, departments, buildings,
            rooms, rows, cabinets, equipment, employees
        };

        state.lookupsLoaded = true;
        state.dataLoaded = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        fillAllFilterOptions();
        
        updateLookupsCache();
        console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞');
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
        toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API: ' + e.message, 4000);
        throw e;
    }
}
function updateLookupsCache() {
    try {
        localStorage.setItem('lookupsCache', JSON.stringify({
            userRole: state.user?.role,
            data: state.data,
            lastUpdated: new Date().toISOString()
        }));
    } catch (e) {
        console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞:', e);
    }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

  // ---------- –§–∏–ª—å—Ç—Ä—ã –∏ –∫–∞—Å–∫–∞–¥—ã ----------
  function updateFiltersVisibility(){
    const wrap = byId('filters');
  const role = state.user?.role?.toLowerCase();
  const toShow = new Set(FILTERS_BY_TAB[state.tab]);
  wrap.style.display = toShow.size ? '' : 'none';
  wrap.querySelectorAll('[data-filter]').forEach(el=>{
    const filterType = el.getAttribute('data-filter');
    let shouldShow = toShow.has(filterType);
    
    // –î–ª—è —ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫–∞ —Å–∫—Ä—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ü–∏—é, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏ –∑–¥–∞–Ω–∏–µ
    if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
      if (['direction', 'department', 'building'].includes(filterType)) {
        shouldShow = false;
      }
    }
    else if (role === '–≥–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä') {
      if (filterType === 'direction') {
        shouldShow = false; // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–∏—Ä–µ–∫—Ü–∏–∏
      }
    }
    // –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫—Ä—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ü–∏—é
    else if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä') {
      if (filterType === 'direction') {
        shouldShow = false;
      }
    }
    else if (role === '—Ü—Å—Å') {
        // –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤–∏–¥–∏–º—ã–º–∏
      }
    el.style.display = shouldShow ? '' : 'none';
  });
  
  // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∏–¥–∏–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–µ–≤—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
  const visibleFilters = wrap.querySelectorAll('[data-filter]').length - 
                        wrap.querySelectorAll('[data-filter][style*="display: none"]').length;
  if (visibleFilters === 0) {
    wrap.style.display = 'none';
  }
}

  function fillAllFilterOptions(){
    const dirSel = byId('f_direction');
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  const filterFn = getDataFilter('directions');
  const filteredDirections = filterFn ? state.data.directions.filter(filterFn) : state.data.directions;
  
  dirSel.innerHTML = `<option value="">–í—Å–µ –¥–∏—Ä–µ–∫—Ü–∏–∏</option>` +
    filteredDirections.map(d=>`<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');
  
  fillDepartmentOptions();
  fillBuildingOptions();
  fillRoomOptions();
  fillRowOptions();
  fillCabinetOptions();
}

function fillDepartmentOptions(){
  const depSel = byId('f_department');
  const dir = state.filters.direction_id;
  
  // –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ü–∏–∏
  let arr = state.data.departments;
  if (dir) {
    arr = arr.filter(d => d.direction_id == dir);
  }
  
  // –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω—è–µ–º —Ä–æ–ª–µ–≤—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
  const filterFn = getDataFilter('departments');
  if (filterFn) {
    arr = arr.filter(filterFn);
  }
  
  depSel.innerHTML = `<option value="">–í—Å–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è</option>` +
    arr.map(d=>`<option value="${d.id}" ${state.filters.department_id == d.id ? 'selected' : ''}>${escapeHtml(d.name)}</option>`).join('');
}

function fillBuildingOptions(){
  const bSel = byId('f_building');
  const dep = state.filters.department_id;
  
  let arr = state.data.buildings;
  if (dep) {
    arr = arr.filter(b => b.department_id == dep);
  }
  
  const filterFn = getDataFilter('buildings');
  if (filterFn) {
    arr = arr.filter(filterFn);
  }
  
  bSel.innerHTML = `<option value="">–í—Å–µ –∑–¥–∞–Ω–∏—è</option>` +
    arr.map(b=>`<option value="${b.id}" ${state.filters.building_id == b.id ? 'selected' : ''}>${escapeHtml(b.name)}</option>`).join('');
}

function fillRoomOptions(){
  const rSel = byId('f_room');
  const b = state.filters.building_id;
  
  let arr = state.data.rooms;
  if (b) {
    arr = arr.filter(x => x.building_id == b);
  }
  
  const filterFn = getDataFilter('rooms');
  if (filterFn) {
    arr = arr.filter(filterFn);
  }
  
  rSel.innerHTML = `<option value="">–í—Å–µ –ø–æ–º–µ—â–µ–Ω–∏—è</option>` +
    arr.map(x=>`<option value="${x.id}" ${state.filters.room_id == x.id ? 'selected' : ''}>${escapeHtml(x.name)}</option>`).join('');
}

function fillRowOptions(){
  const rwSel = byId('f_row');
  const r = state.filters.room_id;
  
  let arr = state.data.rows;
  if (r) {
    arr = arr.filter(x => x.room_id == r);
  }
  
  const filterFn = getDataFilter('cabinet_rows');
  if (filterFn) {
    arr = arr.filter(filterFn);
  }
  
  rwSel.innerHTML = `<option value="">–í—Å–µ —Ä—è–¥—ã</option>` +
    arr.map(x=>`<option value="${x.id}" ${state.filters.row_id == x.id ? 'selected' : ''}>${escapeHtml(x.name)}</option>`).join('');
}

function fillCabinetOptions(){
  const cSel = byId('f_cabinet');
  const row = state.filters.row_id;
  
  let arr = state.data.cabinets;
  if (row) {
    arr = arr.filter(c => c.cabinet_row_id == row);
  }
  
  const filterFn = getDataFilter('cabinets');
  if (filterFn) {
    arr = arr.filter(filterFn);
  }
  
  cSel.innerHTML = `<option value="">–í—Å–µ —à–∫–∞—Ñ—ã</option>` +
    arr.map(x=>`<option value="${x.id}" ${state.filters.cabinet_id == x.id ? 'selected' : ''}>${escapeHtml(x.name || x.code || ('–®–∫–∞—Ñ #'+x.id))}</option>`).join('');
}

function debounce(fn, delay=400) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}

  function bindFilterEvents(){
const debouncedRender = debounce(render, 400);
    byId('f_direction').onchange = (e)=>{
      state.filters.direction_id = e.target.value || null;
      state.filters.department_id = null;
      state.filters.building_id = null;
      state.filters.room_id = null;
      state.filters.row_id = null;
      state.filters.cabinet_id = null;
      fillDepartmentOptions(); fillBuildingOptions(); fillRoomOptions(); fillRowOptions(); fillCabinetOptions();
      debouncedRender();
    };
    byId('f_department').onchange = (e)=>{
      state.filters.department_id = e.target.value || null;
      state.filters.building_id = null;
      state.filters.room_id = null;
      state.filters.row_id = null;
      state.filters.cabinet_id = null;
      fillBuildingOptions(); fillRoomOptions(); fillRowOptions(); fillCabinetOptions();
      debouncedRender();
    };
    byId('f_building').onchange = (e)=>{
      state.filters.building_id = e.target.value || null;
      state.filters.room_id = null;
      state.filters.row_id = null;
      state.filters.cabinet_id = null;
      fillRoomOptions(); fillRowOptions(); fillCabinetOptions();
      debouncedRender();
    };
    byId('f_room').onchange = (e)=>{
      state.filters.room_id = e.target.value || null;
      state.filters.row_id = null;
      state.filters.cabinet_id = null;
      fillRowOptions(); fillCabinetOptions();
      debouncedRender();
    };
    byId('f_row').onchange = (e)=>{
      state.filters.row_id = e.target.value || null;
      state.filters.cabinet_id = null;
      fillCabinetOptions();
      debouncedRender();
    };
    byId('f_cabinet').onchange = (e)=>{
      state.filters.cabinet_id = e.target.value || null;
      debouncedRender();
    };
  }

  let renderLock = false;

async function render(){
  if (renderLock) return;
  renderLock = true;

  try {
    const title = TABS.find(t=>t.key===state.tab).title;
    byId('listTitle').textContent = title;
    byId('formTitle').textContent = (state.edit ? '–ò–∑–º–µ–Ω–∏—Ç—å: ' : '–î–æ–±–∞–≤–∏—Ç—å: ') + title;
    buildTabs();
    updateUIForUserRole();
    updateFiltersVisibility();
    renderForm();
    renderList();
  } finally {
    renderLock = false;
  }
}

  function escapeHtml(s){
    return (s??'').toString().replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  }
  function escapeAttr(s){ return (s??'').toString().replace(/"/g,'&quot;'); }

  function renderList(){
    const wrap = byId('listContainer');
    const F = state.filters;

    // –ë—ã—Å—Ç—Ä—ã–µ –º–∞–ø—ã
    const dirById = Object.fromEntries(state.data.directions.map(x=>[x.id,x]));
    const depById = Object.fromEntries(state.data.departments.map(x=>[x.id,x]));
    const bById   = Object.fromEntries(state.data.buildings.map(x=>[x.id,x]));
    const roomById= Object.fromEntries(state.data.rooms.map(x=>[x.id,x]));
    const rowById = Object.fromEntries(state.data.rows.map(x=>[x.id,x]));
    const cabById = Object.fromEntries(state.data.cabinets.map(x=>[x.id,x]));

    let rows = [];
    let headers = [];

    const roleFilter = getDataFilter(getCurrentEndpoint());

  function applyRoleFilter(data) {
    if (!roleFilter) return data;
    return data.filter(roleFilter);
  }

  function getCurrentEndpoint() {
    switch(state.tab) {
      case 'directions': return 'directions';
      case 'departments': return 'departments';
      case 'buildings': return 'buildings';
      case 'rooms': return 'rooms';
      case 'rows': return 'cabinet_rows';
      case 'cabinets': return 'cabinets';
      case 'equipment': return 'equipment';
      case 'employees': return 'employees_info';
      default: return state.tab;
    }
  }

  switch(state.tab){
    case 'directions':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–î–µ–π—Å—Ç–≤–∏—è'];
      rows = applyRoleFilter(state.data.directions)
        .map(d=>[escapeHtml(d.name), actions('directions', d.id, d)]);
      break;

    case 'departments':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–î–µ–π—Å—Ç–≤–∏—è'];
      let depsData = state.data.departments
        .filter(x=> !F.direction_id || x.direction_id==F.direction_id);
      rows = applyRoleFilter(depsData)
        .map(x=>[escapeHtml(dirById[x.direction_id]?.name||'‚Äî'), escapeHtml(x.name), actions('departments', x.id, x)]);
      break;

    case 'buildings':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–î–µ–π—Å—Ç–≤–∏—è'];
      let bldsData = state.data.buildings
        .filter(x=> !F.department_id || x.department_id==F.department_id)
        .filter(x=> !F.direction_id || (depById[x.department_id]?.direction_id==F.direction_id));
      rows = applyRoleFilter(bldsData)
        .map(x=>[
          escapeHtml(dirById[depById[x.department_id]?.direction_id]?.name || '‚Äî'),
          escapeHtml(depById[x.department_id]?.name || '‚Äî'),
          escapeHtml(x.name),
          actions('buildings', x.id, x)
        ]);
      break;

    case 'rooms':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–ü–æ–º–µ—â–µ–Ω–∏–µ','–î–µ–π—Å—Ç–≤–∏—è'];
      let roomsData = state.data.rooms
        .filter(x=> !F.building_id || x.building_id==F.building_id)
        .filter(x=> !F.department_id || (bById[x.building_id]?.department_id==F.department_id))
        .filter(x=> !F.direction_id || (depById[bById[x.building_id]?.department_id]?.direction_id==F.direction_id));
      rows = applyRoleFilter(roomsData)
        .map(x=>[
          escapeHtml(dirById[depById[bById[x.building_id]?.department_id]?.direction_id]?.name || '‚Äî'),
          escapeHtml(depById[bById[x.building_id]?.department_id]?.name || '‚Äî'),
          escapeHtml(bById[x.building_id]?.name || '‚Äî'),
          escapeHtml(x.name),
          actions('rooms', x.id, x)
        ]);
      break;

    case 'rows':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–ü–æ–º–µ—â–µ–Ω–∏–µ','–†—è–¥','–î–µ–π—Å—Ç–≤–∏—è'];
      let rowsData = state.data.rows
        .filter(x=> !F.room_id || x.room_id==F.room_id)
        .filter(x=> !F.building_id || (roomById[x.room_id]?.building_id==F.building_id))
        .filter(x=> !F.department_id || (bById[roomById[x.room_id]?.building_id]?.department_id==F.department_id))
        .filter(x=> !F.direction_id || (depById[bById[roomById[x.room_id]?.building_id]?.department_id]?.direction_id==F.direction_id));
      rows = applyRoleFilter(rowsData)
        .map(x=>[
          escapeHtml(dirById[depById[bById[roomById[x.room_id]?.building_id]?.department_id]?.direction_id]?.name || '‚Äî'),
          escapeHtml(depById[bById[roomById[x.room_id]?.building_id]?.department_id]?.name || '‚Äî'),
          escapeHtml(bById[roomById[x.room_id]?.building_id]?.name || '‚Äî'),
          escapeHtml(roomById[x.room_id]?.name || '‚Äî'),
          escapeHtml(x.name),
          actions('cabinet_rows', x.id, x)
        ]);
      break;

    case 'cabinets':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–ü–æ–º–µ—â–µ–Ω–∏–µ','–†—è–¥','–®–∫–∞—Ñ','–î–µ–π—Å—Ç–≤–∏—è'];
      let cabsData = state.data.cabinets
        .filter(x=> !F.row_id || x.cabinet_row_id==F.row_id)
        .filter(x=> !F.room_id || (rowById[x.cabinet_row_id]?.room_id==F.room_id))
        .filter(x=> !F.building_id || (roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id==F.building_id))
        .filter(x=> !F.department_id || (bById[roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id]?.department_id==F.department_id))
        .filter(x=> !F.direction_id || (depById[bById[roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id]?.department_id]?.direction_id==F.direction_id));
      rows = applyRoleFilter(cabsData)
        .map(x=>[
          escapeHtml(dirById[depById[bById[roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id]?.department_id]?.direction_id]?.name || '‚Äî'),
          escapeHtml(depById[bById[roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id]?.department_id]?.name || '‚Äî'),
          escapeHtml(bById[roomById[rowById[x.cabinet_row_id]?.room_id]?.building_id]?.name || '‚Äî'),
          escapeHtml(roomById[rowById[x.cabinet_row_id]?.room_id]?.name || '‚Äî'),
          escapeHtml(rowById[x.cabinet_row_id]?.name || '‚Äî'),
          escapeHtml(x.name || x.code || '‚Äî'),
          actions('cabinets', x.id, x)
        ]);
      break;

    case 'equipment':
  headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–ü–æ–º–µ—â–µ–Ω–∏–µ','–†—è–¥','–®–∫–∞—Ñ','–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ','–°–µ—Ä–∏–π–Ω—ã–π ‚Ññ','–î–µ–π—Å—Ç–≤–∏—è'];
  let eqData = state.data.equipment
    .filter(x=> !F.cabinet_id || x.cabinet_id==F.cabinet_id)
    .filter(x=> !F.row_id || (cabById[x.cabinet_id]?.cabinet_row_id==F.row_id))
    .filter(x=> !F.room_id || (roomById[rowById[cabById[x.cabinet_id]?.cabinet_row_id]?.room_id]?.id==F.room_id))
    .filter(x=> !F.building_id || (bById[roomById[rowById[cabById[x.cabinet_id]?.cabinet_row_id]?.room_id]?.building_id]?.id==F.building_id))
    .filter(x=> !F.department_id || (depById[bById[roomById[rowById[cabById[x.cabinet_id]?.cabinet_row_id]?.room_id]?.building_id]?.department_id]?.id==F.department_id))
    .filter(x=> !F.direction_id || (dirById[depById[bById[roomById[rowById[cabById[x.cabinet_id]?.cabinet_row_id]?.room_id]?.building_id]?.department_id]?.direction_id]?.id==F.direction_id));
  rows = applyRoleFilter(eqData)
    .map(x=>{
      // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∏ –Ω–∞–¥–µ–∂–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      const cabinet = cabById[x.cabinet_id];
      const cabinetRow = rowById[cabinet?.cabinet_row_id];
      const room = roomById[cabinetRow?.room_id];
      const building = bById[room?.building_id];
      const department = depById[building?.department_id];
      const direction = dirById[department?.direction_id];
      
      return [
        escapeHtml(direction?.name || '‚Äî'),
        escapeHtml(department?.name || '‚Äî'),
        escapeHtml(building?.name || '‚Äî'), // –¢–µ–ø–µ—Ä—å –∑–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
        escapeHtml(room?.name || '‚Äî'),
        escapeHtml(cabinetRow?.name || '‚Äî'),
        escapeHtml(cabinet?.name || cabinet?.code || '‚Äî'),
        escapeHtml(x.name || '‚Äî'),
        escapeHtml(x.serial_number || '‚Äî'),
        actions('equipment', x.id, x, /* isEquipment */ true)
      ];
    });
  break;

    case 'employees':
      headers = ['–î–∏—Ä–µ–∫—Ü–∏—è','–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ','–ó–¥–∞–Ω–∏–µ','–§–ò–û','–†–æ–ª—å','–õ–æ–≥–∏–Ω','–î–µ–π—Å—Ç–≤–∏—è'];
      let empsData = state.data.employees
        .filter(x=> !F.department_id || x.department_id==F.department_id)
        .filter(x=> !F.direction_id || x.direction_id==F.direction_id)
        .filter(x=> !F.building_id || x.building_id==F.building_id);
      rows = applyRoleFilter(empsData)
        .map(x=>[
          escapeHtml(dirById[x.direction_id]?.name || '‚Äî'),
          escapeHtml(depById[x.department_id]?.name || '‚Äî'),
          escapeHtml(bById[x.building_id]?.name || '‚Äî'),
          escapeHtml(x.full_name),
          escapeHtml(x.role),
          escapeHtml(x.login),
          actions('employees_info', x.id, x)
        ]);
      break;
  }

  if(!rows.length){
    wrap.innerHTML = '<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
    return;
  }

  let html = '<table><thead><tr>';
  html += headers.map(h=>`<th>${h}</th>`).join('');
  html += '</tr></thead><tbody>';
  for(const r of rows){
    const actionsHtml = r[r.length-1];
    const meta = parseActionMeta(actionsHtml);
    const isJustAdded = state.justAdded && state.justAdded.endpoint===meta.endpoint && state.justAdded.id==meta.id;
    html += `<tr data-endpoint="${meta.endpoint}" data-id="${meta.id}" class="${isJustAdded?'row-added':''}">` +
            r.map((c,i)=>`<td>${(c ?? '‚Äî')}</td>`).join('') + '</tr>';
  }
  html += '</tbody></table>';
  wrap.innerHTML = html;

  // –°–±—Ä–æ—Å –ø–æ–º–µ—Ç–∫–∏ "—Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ" —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É
  if(state.justAdded){
    setTimeout(()=>{ state.justAdded = null; }, 1000);
  }
}

  // –¥–æ—Å—Ç–∞—ë–º endpoint –∏ id –∏–∑ html –¥–µ–π—Å—Ç–≤–∏–π
  function parseActionMeta(html){
    // –∏—â–µ–º onDelete('<endpoint>', id)
    const m = html.match(/onDelete\('([^']+)',\s*([0-9]+)\)/);
    return { endpoint: m ? m[1] : '', id: m ? +m[2] : 0 };
  }

  function actions(endpoint, id, record, isEquipment){
  const role = state.user?.role?.toLowerCase();

  // –≠–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫ ‚Äì —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
    return endpoint === 'equipment'
      ? `<div class="actions"><button class="btn" type="button" onclick='openFilesDrawer(${id})'>–§–∞–π–ª—ã</button></div>`
      : '';
  }

  // –û–ø–µ—Ä–∞—Ç–æ—Ä ‚Äì —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
  if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä') {
    if (endpoint === 'employees_info') {
      return `
        <div class="actions">
          <button class="btn secondary" type="button" onclick='onEdit("${endpoint}", ${id})'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>`;
    }
    return '';
  }

 // –¶–°–° - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –¥–µ–π—Å—Ç–≤–∏—è–º
    if (role === '—Ü—Å—Å') {
      const filesBtn = (endpoint==='equipment')
        ? `<button class="btn" type="button" onclick='openFilesDrawer(${id})'>–§–∞–π–ª—ã</button>`
        : '';
      return `
        <div class="actions">
          ${filesBtn}
          <button class="btn danger" type="button" onclick="onDelete('${endpoint}', ${id})">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn secondary" type="button" onclick='onEdit("${endpoint}", ${id})'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>`;
    }
    const filesBtn = (endpoint==='equipment')
      ? `<button class="btn" type="button" onclick='openFilesDrawer(${id})'>–§–∞–π–ª—ã</button>`
      : '';
    return `
      <div class="actions">
        ${filesBtn}
        <button class="btn danger" type="button" onclick="onDelete('${endpoint}', ${id})">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn secondary" type="button" onclick='onEdit("${endpoint}", ${id})'>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>`;
  }

  function renderForm(){
   const form = byId('form');
  const F = state.filters;
  const editing = state.edit;
  
  const role = state.user?.role?.toLowerCase();
  if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
    form.innerHTML = '<div class="empty">–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</div>';
    return;
  }
  if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä' && state.tab !== 'employees') {
    form.innerHTML = '<div class="empty">–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–∏</div>';
    return;
  }
  if (role === '—Ü—Å—Å') {
      // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    }
    else if (role === '–≥–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä' && state.user.direction_id) {
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–∏—Ä–µ–∫—Ü–∏–∏ –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      if (!F.direction_id) {
        F.direction_id = state.user.direction_id;
      }
    }

 
  // –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ–≤
  const filteredDirections = getDataFilter('directions') 
    ? state.data.directions.filter(getDataFilter('directions'))
    : state.data.directions;
    
  const filteredDepartments = getDataFilter('departments')
    ? state.data.departments.filter(getDataFilter('departments'))
    : state.data.departments;
    
  const filteredBuildings = getDataFilter('buildings')
    ? state.data.buildings.filter(getDataFilter('buildings'))
    : state.data.buildings;
    
  const filteredRooms = getDataFilter('rooms')
    ? state.data.rooms.filter(getDataFilter('rooms'))
    : state.data.rooms;
    
  const filteredRows = getDataFilter('cabinet_rows')
    ? state.data.rows.filter(getDataFilter('cabinet_rows'))
    : state.data.rows;
    
  const filteredCabinets = getDataFilter('cabinets')
    ? state.data.cabinets.filter(getDataFilter('cabinets'))
    : state.data.cabinets;

  // –∑–∞–≥–æ—Ç–æ–≤–∫–∏ —Å–µ–ª–µ–∫—Ç–æ–≤ (—Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
  const dirSel = `<label>–î–∏—Ä–µ–∫—Ü–∏—è *</label>
    <select id="a_dir"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
    ${filteredDirections.map(d=>`<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('')}
    </select>`;

  const depSel = `<label>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ *</label>
    <select id="a_dep"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>`;

  const bSel = `<label>–ó–¥–∞–Ω–∏–µ *</label>
    <select id="a_bld"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>`;

  const rSel = `<label>–ü–æ–º–µ—â–µ–Ω–∏–µ *</label>
    <select id="a_room"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>`;

  const rowSel = `<label>–†—è–¥ —à–∫–∞—Ñ–æ–≤ *</label>
    <select id="a_row"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>`;

  const cabSel = `<label>–®–∫–∞—Ñ *</label>
    <select id="a_cab"><option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>`;

  let html = '<div class="muted" style="margin-bottom:8px">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.</div>';

  switch(state.tab){
    case 'directions': {
      const nameVal = editing?.record?.name || '';
      html += `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('directions', editing);
      break;
    }
    case 'departments': {
      const nameVal = editing?.record?.name || '';
      html += dirSel + `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('departments', editing);
      break;
    }
    case 'buildings': {
      const nameVal = editing?.record?.name || '';
      html += dirSel + depSel + `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('buildings', editing);
      break;
    }
    case 'rooms': {
      const nameVal = editing?.record?.name || '';
      html += dirSel + depSel + bSel + `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('rooms', editing);
      break;
    }
    case 'rows': {
      const nameVal = editing?.record?.name || '';
      html += dirSel + depSel + bSel + rSel + `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('cabinet_rows', editing);
      break;
    }
    case 'cabinets': {
      const nameVal = editing?.record?.name || '';
      html += dirSel + depSel + bSel + rSel + rowSel + `<label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />`;
      html += actionButtons('cabinets', editing);
      break;
    }
    case 'equipment': {
      const nameVal = editing?.record?.name || '';
      const descVal = editing?.record?.description || '';
      const snVal = editing?.record?.serial_number || '';
      html += dirSel + depSel + bSel + rSel + rowSel + cabSel +
        `<label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label><input id="a_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" value="${escapeAttr(nameVal)}" />` +
        `<label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input id="a_desc" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ" value="${escapeAttr(descVal)}" />` +
        `<label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</label><input id="a_sn" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä" value="${escapeAttr(snVal)}" />`;
      html += actionButtons('equipment', editing);
      break;
    }
    case 'employees': {
  const e = editing?.record || {};
  
  // –°–æ–∑–¥–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–æ–ª–µ–π
  const roleOptions = ['–ì–ª–∞–≤–Ω—ã–π –∏–Ω–∂–µ–Ω–µ—Ä', '–û–ø–µ—Ä–∞—Ç–æ—Ä', '–≠–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫', '–¶–°–°'];
  const roleSelect = `
    <select id="a_role">
      <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
      ${roleOptions.map(role => 
        `<option value="${role}" ${e.role === role ? 'selected' : ''}>${role}</option>`
      ).join('')}
    </select>
  `;
  
  html += `
    <div class="form-grid">
      <div>
        <label>–§–ò–û *</label>
        <input id="a_full_name" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û" value="${escapeAttr(e.full_name||'')}" />
      </div>
      <div>
        <label>–†–æ–ª—å *</label>
        ${roleSelect}
      </div>
      <div>
        ${dirSel}
      </div>
      <div>
        ${depSel}
      </div>
      <div>
        ${bSel}
      </div>
      <div>
        <label>–õ–æ–≥–∏–Ω *</label>
        <input id="a_login" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω" value="${escapeAttr(e.login||'')}" />
      </div>
      <div>
        <label>–ü–∞—Ä–æ–ª—å ${editing ? '(–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)' : '*'}</label>
        <input id="a_password" type="password" placeholder="${editing ? '–Ω–µ –º–µ–Ω—è—Ç—å' : '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'}" />
      </div>
    </div>
    <div class="hint">–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è bcrypt-—Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ. –ï—Å–ª–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä–æ–ª—å –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –æ–Ω –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è.</div>
  `;
  html += actionButtons('employees_info', editing);
  break;
}
  }

  form.innerHTML = html;

  // --- –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–∞—Å–∫–∞–¥ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã ---
  const formDir = byId('a_dir');
  const formDep = byId('a_dep');
  const formBld = byId('a_bld');
  const formRoom= byId('a_room');
  const formRow = byId('a_row');
  const formCab = byId('a_cab');

  // helpers –¥–ª—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
  function setDeps(dirId, selected){
    let arr = filteredDepartments;
    if (dirId) {
      arr = arr.filter(d => d.direction_id == dirId);
    }
    formDep && (formDep.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + arr.map(d=>`<option value="${d.id}" ${selected==d.id?'selected':''}>${escapeHtml(d.name)}</option>`).join(''));
  }
  
  function setBlds(depId, selected){
    let arr = filteredBuildings;
    if (depId) {
      arr = arr.filter(b => b.department_id == depId);
    }
    formBld && (formBld.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + arr.map(b=>`<option value="${b.id}" ${selected==b.id?'selected':''}>${escapeHtml(b.name)}</option>`).join(''));
  }
  
  function setRooms(bldId, selected){
    let arr = filteredRooms;
    if (bldId) {
      arr = arr.filter(r => r.building_id == bldId);
    }
    formRoom && (formRoom.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + arr.map(r=>`<option value="${r.id}" ${selected==r.id?'selected':''}>${escapeHtml(r.name)}</option>`).join(''));
  }
  
  function setRows(roomId, selected){
    let arr = filteredRows;
    if (roomId) {
      arr = arr.filter(r => r.room_id == roomId);
    }
    formRow && (formRow.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + arr.map(r=>`<option value="${r.id}" ${selected==r.id?'selected':''}>${escapeHtml(r.name)}</option>`).join(''));
  }
  
  function setCabs(rowId, selected){
    let arr = filteredCabinets;
    if (rowId) {
      arr = arr.filter(c => c.cabinet_row_id == rowId);
    }
    formCab && (formCab.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + arr.map(c=>`<option value="${c.id}" ${selected==c.id?'selected':''}>${escapeHtml(c.name || c.code || ('–®–∫–∞—Ñ #'+c.id))}</option>`).join(''));
  }

    // –Ω–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    if(editing){
      const rec = editing.record;
      switch(state.tab){
        case 'departments':
          formDir && (formDir.value = rec.direction_id);
          setDeps(rec.direction_id);
          break;
        case 'buildings': {
          const depId = rec.department_id;
          const dirId = state.data.departments.find(d=>d.id==depId)?.direction_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          break;
        }
        case 'rooms': {
          const bldId = rec.building_id;
          const depId = state.data.buildings.find(b=>b.id==bldId)?.department_id;
          const dirId = state.data.departments.find(d=>d.id==depId)?.direction_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          setBlds(depId, bldId);
          break;
        }
        case 'rows': {
          const roomId = rec.room_id;
          const bldId  = state.data.rooms.find(r=>r.id==roomId)?.building_id;
          const depId  = state.data.buildings.find(b=>b.id==bldId)?.department_id;
          const dirId  = state.data.departments.find(d=>d.id==depId)?.direction_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          setBlds(depId, bldId);
          setRooms(bldId, roomId);
          break;
        }
        case 'cabinets': {
          const rowId  = rec.cabinet_row_id;
          const roomId = state.data.rows.find(r=>r.id==rowId)?.room_id;
          const bldId  = state.data.rooms.find(r=>r.id==roomId)?.building_id;
          const depId  = state.data.buildings.find(b=>b.id==bldId)?.department_id;
          const dirId  = state.data.departments.find(d=>d.id==depId)?.direction_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          setBlds(depId, bldId);
          setRooms(bldId, roomId);
          setRows(roomId, rowId);
          break;
        }
        case 'equipment': {
          const cabId = rec.cabinet_id;
          const rowId  = state.data.cabinets.find(c=>c.id==cabId)?.cabinet_row_id;
          const roomId = state.data.rows.find(r=>r.id==rowId)?.room_id;
          const bldId  = state.data.rooms.find(r=>r.id==roomId)?.building_id;
          const depId  = state.data.buildings.find(b=>b.id==bldId)?.department_id;
          const dirId  = state.data.departments.find(d=>d.id==depId)?.direction_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          setBlds(depId, bldId);
          setRooms(bldId, roomId);
          setRows(roomId, rowId);
          setCabs(rowId, cabId);
          break;
        }
        case 'employees': {
          const dirId = rec.direction_id;
          const depId = rec.department_id;
          formDir && (formDir.value = dirId || '');
          setDeps(dirId, depId);
          setBlds(depId, rec.building_id);
          break;
        }
      }
    } else {
      // –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º –ø–æ–¥—Å—Ç–∞–≤–∏–º –∑–Ω–∞—á–µ–Ω–∏—è (—É–¥–æ–±–Ω–µ–µ –¥–æ–±–∞–≤–ª—è—Ç—å)
      if(formDir){ formDir.value = F.direction_id || ''; setDeps(F.direction_id, F.department_id||''); }
      if(formDep && F.department_id){ setBlds(F.department_id, F.building_id || ''); }
      if(formDep && F.department_id){ setBlds(F.department_id, F.building_id||''); }
      if(formBld && F.building_id){ setRooms(F.building_id, F.room_id||''); }
      if(formRoom && F.room_id){ setRows(F.room_id, F.row_id||''); }
      if(formRow && F.row_id){ setCabs(F.row_id, F.cabinet_id||''); }
    }

    // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∫–∞–¥–∞ –≤ —Ñ–æ—Ä–º–µ
    if(formDir){
      formDir.onchange = ()=>{
        setDeps(formDir.value || '');
        if(formBld) formBld.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formRoom) formRoom.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formRow)  formRow.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formCab)  formCab.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      };
    }
    if(formDep){
      formDep.onchange = ()=>{
        setBlds(formDep.value || '');
        if(formRoom) formRoom.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formRow)  formRow.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formCab)  formCab.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      };
    }
    if(formBld){
      formBld.onchange = ()=>{
        setRooms(formBld.value || '');
        if(formRow)  formRow.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
        if(formCab)  formCab.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      };
    }
    if(formRoom){
      formRoom.onchange = ()=>{
        setRows(formRoom.value || '');
        if(formCab)  formCab.innerHTML  = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>';
      };
    }
    if(formRow){
      formRow.onchange = ()=>{
        setCabs(formRow.value || '');
      };
    }
  }

  function actionButtons(endpoint, editing){
    const saveLabel = editing ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    const clearLabel= editing ? '–û—Ç–º–µ–Ω–∞' : '–û—á–∏—Å—Ç–∏—Ç—å';
    return `
      <div class="form-actions">
        <button class="btn" type="button" onclick="onSave('${endpoint}')">${saveLabel}</button>
        <button class="btn secondary" type="button" onclick="onClearForm()">${clearLabel}</button>
      </div>
    `;
  }

  function onClearForm(){
    state.edit = null;
    renderForm();
  }

  // ---------- CRUD ----------
  async function onSave(endpoint){
  const role = state.user?.role?.toLowerCase();
  if (role === '—ç–ª–µ–∫—Ç—Ä–æ–º–µ—Ö–∞–Ω–∏–∫') {
    return toast('–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
  }
  if (role === '–æ–ø–µ—Ä–∞—Ç–æ—Ä' && endpoint !== 'employees_info') {
    return toast('–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏');
  }
  if (role === '—Ü—Å—Å') {
      // –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    }
    try{
      const editing = state.edit && state.edit.endpoint===endpoint ? state.edit : null;
      let payload = {};

      switch(endpoint){
        case 'directions': {
          const name = byId('a_name').value.trim();
          if(!name) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ü–∏–∏');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –¥–∏—Ä–µ–∫—Ü–∏–∏
          const isNameUnique = await checkNameUnique('directions', name, editing?.id);
          if (!isNameUnique) {
            return toast('–î–∏—Ä–µ–∫—Ü–∏—è —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
          }
          
          payload = { name };
          break;
        }
        case 'departments': {
          const direction_id = +byId('a_dir').value;
          const name = byId('a_name').value.trim();
          if(!direction_id || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤ –¥–∏—Ä–µ–∫—Ü–∏–∏
          const isNameUnique = await checkNameUnique('departments', name, editing?.id);
          if (!isNameUnique) {
            return toast('–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ü–∏–∏');
          }
          
          payload = { direction_id, name };
          break;
        }
        case 'buildings': {
          const depId = +byId('a_dep').value;
          const name = byId('a_name').value.trim();
          if(!depId || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –∑–¥–∞–Ω–∏—è –≤ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏
          const isNameUnique = await checkNameUnique('buildings', name, editing?.id);
          if (!isNameUnique) {
            return toast('–ó–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–∏');
          }
          
          payload = { department_id: depId, name };
          break;
        }
        case 'rooms': {
          const bldId = +byId('a_bld').value;
          const name = byId('a_name').value.trim();
          if(!bldId || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –ø–æ–º–µ—â–µ–Ω–∏—è –≤ –∑–¥–∞–Ω–∏–∏
          const isNameUnique = await checkRoomUnique(name, bldId, editing?.id);
          if (!isNameUnique) {
            return toast('–ü–æ–º–µ—â–µ–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –∑–¥–∞–Ω–∏–∏');
          }
          
          // –í –ë–î rooms —Ç—Ä–µ–±—É–µ—Ç—Å—è department_id ‚Äî –±–µ—Ä—ë–º –µ–≥–æ —á–µ—Ä–µ–∑ –∑–¥–∞–Ω–∏–µ
          const depId = state.data.buildings.find(b=>b.id==bldId)?.department_id;
          payload = { building_id: bldId, department_id: depId, name };
          break;
        }
        case 'cabinet_rows': {
          const roomId = +byId('a_room').value;
          const name = byId('a_name').value.trim();
          if(!roomId || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ —Ä—è–¥–∞ –≤ –ø–æ–º–µ—â–µ–Ω–∏–∏
          const isNameUnique = await checkNameUnique('cabinet_rows', name, editing?.id);
          if (!isNameUnique) {
            return toast('–†—è–¥ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏');
          }
          
          payload = { room_id: roomId, name };
          break;
        }
        case 'cabinets': {
          const rowId = +byId('a_row').value;
          const name = byId('a_name').value.trim();
          if(!rowId || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ —à–∫–∞—Ñ–∞ –≤ —Ä—è–¥—É
          const isNameUnique = await checkCabinetUnique(name, rowId, editing?.id);
          if (!isNameUnique) {
            return toast('–®–∫–∞—Ñ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º —Ä—è–¥—É');
          }
          
          payload = { cabinet_row_id: rowId, name };
          break;
        }
        case 'equipment': {
          const cabId = +byId('a_cab').value;
          const name = byId('a_name').value.trim();
          if(!cabId || !name) return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –≤ —à–∫–∞—Ñ—É
          const isNameUnique = await checkEquipmentUnique(name, cabId, editing?.id);
          if (!isNameUnique) {
            return toast('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–º —à–∫–∞—Ñ—É');
          }
          
          payload = {
            cabinet_id: cabId,
            name,
            description: byId('a_desc').value.trim() || null,
            serial_number: byId('a_sn').value.trim() || null
          };
          break;
        }
       case 'employees_info': {
          const userRole = state.user?.role ? state.user.role.toLowerCase() : '';
          const isOperator = userRole === '–æ–ø–µ—Ä–∞—Ç–æ—Ä';
          let dirId, depId, bldId;
          
          if (isOperator) {
            dirId = state.user.direction_id;
            depId = state.user.department_id;
            bldId = byId('a_bld').value ? +byId('a_bld').value : null;
          } else {
            dirId = +byId('a_dir').value;
            depId = +byId('a_dep').value;
            bldId = +byId('a_bld').value;
          }
          
          const full_name = byId('a_full_name').value.trim();
          const role = byId('a_role').value;
          const login = byId('a_login').value.trim();
          const password = byId('a_password').value;
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
          if(!dirId || !depId || !bldId || !full_name || !role || !login || (!editing && !password)){
            return toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
          }
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∏–Ω–∞
          const isLoginUnique = await checkLoginUnique(login, editing?.id);
          if (!isLoginUnique) {
            return toast('–õ–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –ª–æ–≥–∏–Ω.');
          }
          
          payload = { direction_id: dirId, department_id: depId, building_id: bldId, full_name, role, login };
          if(password) payload.password = password;
          break;
        }
      }

      let result;
      if(editing){
        result = await apiPut(`${endpoint}/${editing.id}`, payload);
        toast('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      }else{
        result = await apiPost(endpoint, payload);
        toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        // –æ—Ç–º–µ—Ç–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        if(result && result.id){
          state.justAdded = { endpoint, id: result.id, ts: Date.now() };
        }
      }

      state.edit = null;

      // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
      await loadLookups(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      await render();
    }catch(e){
      console.error(e);
      toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+e.message, 5000);
    }
  }

  async function onDelete(endpoint, id){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) return;
    try{
      // –Ω–∞–π–¥—ë–º —Å—Ç—Ä–æ–∫—É –∏ –∞–Ω–∏–º–∏—Ä—É–µ–º
      const row = document.querySelector(`tr[data-endpoint="${endpoint}"][data-id="${id}"]`);
      if(row){
        row.classList.add('row-removed');
      }
      // –ø–æ–¥–æ–∂–¥—ë–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
      await new Promise(r=> setTimeout(r, 260));

      await apiDelete(`${endpoint}/${id}`);
      toast('–£–¥–∞–ª–µ–Ω–æ');
      await loadLookups();
      await render();
    }catch(e){
      console.error(e);
      toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+e.message, 4000);
      // –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ —É–±–µ—Ä—ë–º –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ
      const row = document.querySelector(`tr[data-endpoint="${endpoint}"][data-id="${id}"]`);
      if(row){
        row.classList.remove('row-removed');
      }
    }
  }

  function onEdit(endpoint, id){
    // –Ω–∞–π–¥—ë–º –∑–∞–ø–∏—Å—å –≤ state.data –ø–æ endpoint
    let collectionKey = null;
    switch(endpoint){
      case 'directions': collectionKey='directions'; break;
      case 'departments': collectionKey='departments'; break;
      case 'buildings': collectionKey='buildings'; break;
      case 'rooms': collectionKey='rooms'; break;
      case 'cabinet_rows': collectionKey='rows'; break;
      case 'cabinets': collectionKey='cabinets'; break;
      case 'equipment': collectionKey='equipment'; break;
      case 'employees_info': collectionKey='employees'; break;
    }
    const rec = state.data[collectionKey].find(x=>x.id==id);
    if(!rec) return toast('–ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    state.edit = {endpoint, id, record: rec};
    renderForm();
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // ===== Drawer logic =====
  const drawerEl = byId('filesDrawer');
  const backdropEl = byId('drawerBackdrop');
  const tabFilesBtn = byId('tabFilesBtn');
  const tabFiles = byId('tabFiles');

  function openFilesDrawer(equipmentId){
    const eq = state.data.equipment.find(x=>x.id==equipmentId);
    state.drawer.open = true;
    state.drawer.equipmentId = equipmentId;
    state.drawer.equipmentName = eq?.name || ('–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ #'+equipmentId);
    state.drawer.activeTab = 'files';
    byId('drawerTitle').textContent = '–§–∞–π–ª—ã: ' + state.drawer.equipmentName;
    backdropEl.classList.add('open');
    drawerEl.classList.add('open');
    drawerEl.setAttribute('aria-hidden', 'false');
    drawerEl.removeAttribute('inert');
       // –§–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    setTimeout(() => {
        byId('drawerCloseBtn').focus();
    }, 100);
    
    switchDrawerTab('files');
    // –ø–æ–¥–≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ
    refreshFiles();
}
  function closeFilesDrawer(){
    state.drawer.open = false;
    backdropEl.classList.remove('open');
    drawerEl.classList.remove('open');
    drawerEl.setAttribute('aria-hidden', 'true'); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º
    drawerEl.setAttribute('inert', ''); // –î–æ–±–∞–≤–ª—è–µ–º inert –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
  }
  byId('drawerCloseBtn').onclick = closeFilesDrawer;
  backdropEl.onclick = closeFilesDrawer;
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && state.drawer.open) {
        closeFilesDrawer();
    }
  });

  function switchDrawerTab(which){
    state.drawer.activeTab = which;
    tabFilesBtn.classList.toggle('active', which === 'files');
    tabFiles.style.display = which === 'files' ? 'block' : 'none';
  }
  tabFilesBtn.onclick = ()=> switchDrawerTab('files');

  async function refreshFiles(){
    const id = state.drawer.equipmentId;
    if(!id) return;
    try{
      const files = await apiGet(`/equipment/${id}/files`);
      state.drawer.files = Array.isArray(files) ? files : [];
      renderFilesList();
    }catch(e){
      console.error(e);
      state.drawer.files = [];
      renderFilesList();
      toast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤: '+e.message, 4000);
    }
  }

  function renderFilesList(){
	const box = byId('filesList');
	const files = state.drawer.files;
	if(!files.length){
		box.innerHTML = '<div class="empty">–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel/CSV —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ.</div>';
		return;
    }
    box.innerHTML = files.map(f=>{
	const when = f.uploaded_at ? new Date(f.uploaded_at).toLocaleString() : '';
	return `
		<div class="file-item" id="file-${f.id}">
			<div class="file-head">
				<div>
					<div><b>${escapeHtml(f.name || '–§–∞–π–ª')}</b></div>
						<div class="soft small">ID: ${f.id ?? '‚Äî'} ¬∑ ${when ? ('–ó–∞–≥—Ä—É–∂–µ–Ω: '+when) : ''}</div>
				</div>
				<div class="file-actions">
					<button class="btn" type="button" onclick="toggleFilePreview(${f.id})">–û—Ç–∫—Ä—ã—Ç—å</button>
					<button class="btn secondary" type="button" onclick="downloadFile(${f.id})">–°–∫–∞—á–∞—Ç—å</button>
					<button class="btn danger" type="button" onclick="deleteFile(${f.id})">–£–¥–∞–ª–∏—Ç—å</button>
				</div>
			</div>
			<div class="file-preview soft small" style="display:none; margin-top:8px;"></div>
			</div>`;
			}).join('');
  }

  function renderPreviewTable(rows){
    if(!Array.isArray(rows) || !rows.length) return '<div class="soft small" style="margin-top:6px">–ù–µ—Ç –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>';
    const header = rows[0] || [];
    const body = rows.slice(1, 51); // –ø–æ–∫–∞–∂–µ–º –¥–æ 50 —Å—Ç—Ä–æ–∫
    let html = '<div class="table-scroll"><table class="mini-table"><thead><tr>';
    html += header.map(h=>`<th>${escapeHtml(String(h))}</th>`).join('');
    html += '</tr></thead><tbody>';
    for(const r of body){
      html += '<tr>'+ (r||[]).map(c=>`<td>${escapeHtml(String(c??''))}</td>`).join('') + '</tr>';
    }
    html += '</tbody></table></div>';
    return html;
  }

	function toggleFilePreview(fileId){
		const file = state.drawer.files.find(f=>f.id===fileId);
		if(!file) return;
		const wrap = document.querySelector(`#file-${fileId} .file-preview`);
		if(!wrap) return;

		if(wrap.style.display==='none'){
			wrap.innerHTML = renderPreviewTable(file.preview || file.data || []);
			wrap.style.display = 'block';
		}else{
			wrap.style.display = 'none';
		}
	}

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
  byId('uploadForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fileInput = byId('uploadFileInput');
    const file = fileInput.files && fileInput.files[0];
    if(!file) { toast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª'); return; }
    try{
      const fd = new FormData();
      fd.append('file', file);
      await apiPostForm(`/equipment/${state.drawer.equipmentId}/upload`, fd);
      fileInput.value = '';
      toast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
      await refreshFiles();
    }catch(err){
      console.error(err);
      toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+err.message, 5000);
    }
  });

  // –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª (–ø—ã—Ç–∞–µ–º—Å—è —á–µ—Ä–µ–∑ download_url, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç)
 async function downloadFile(fileId){
  try{
    const base = getApiBase().replace(/\/$/, '');
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–∞—Ä—à—Ä—É—Ç
    const downloadUrl = `${base}/equipment/files/${fileId}/download`;
    window.open(downloadUrl, '_blank');
  }catch(e){
    console.error(e);
    toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª', 3000);
  }
}

  async function deleteFile(fileId){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')) return;
    try{
      await apiDelete(`/equipment/files/${fileId}`);
      toast('–§–∞–π–ª —É–¥–∞–ª—ë–Ω');
      await refreshFiles();
    }catch(e){
      console.error(e);
      toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+e.message, 4000);
    }
  }

  function byId(id){ return document.getElementById(id); }

  // ---------- –°—Ç–∞—Ä—Ç ----------
  (async function init(){
    const apiInput = byId('apiBaseInput');
    const saved = localStorage.getItem('apiBase');
    if(saved){ 
        apiInput.value = saved; 
    }
    
    byId('saveApiBtn').onclick = ()=>{
        const v = apiInput.value.trim();
        if(v) localStorage.setItem('apiBase', v);
        toast('API —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    };

    const savedUser = localStorage.getItem('userData');
    if (savedUser) {
        try {
            state.user = JSON.parse(savedUser);
            
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('loginModal').style.display = 'none';
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            await loadLookups(false); // false = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à –µ—Å–ª–∏ –æ–Ω –≤–∞–ª–∏–¥–µ–Ω
            
            bindFilterEvents();
            resetFilters();
            updateUIForUserRole();
            updateUserInfo();
            await render();
            
            try {
                const result = await apiGet('site/last-updates');
                state.autoRefresh.lastUpdate = result.last_update;
                console.log('üïí –ù–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ:', state.autoRefresh.lastUpdate);
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏:', error);
            }
            
            startAutoRefresh();
            
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
            localStorage.removeItem('userData');
            localStorage.removeItem('lookupsCache');
            showLoginModal();
        }
    } else {
        showLoginModal();
    }
})();
window.onload = () => {
  const savedApi = localStorage.getItem('apiBase');
  if (savedApi) {
    document.getElementById('apiBaseInput').value = savedApi;  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π API
  }
};
window.addEventListener('beforeunload', function(e) {
    // –ú–æ–∂–Ω–æ —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –Ω–æ —ç—Ç–æ —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    // return '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
  });
  </script>
</body>
</html>
